<% back_config = case params[:ref]
    when "alerts" then { path: alerts_path, label: "Margin Alerts" }
    when "events" then { path: events_path, label: "Events" }
    else { path: customers_path, label: "All Customers" }
  end %>
<div class="mb-4">
  <%= link_to back_config[:path], class: "inline-flex items-center gap-1 text-sm text-slate-500 hover:text-slate-700 transition-colors" do %>
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
    <%= back_config[:label] %>
  <% end %>
</div>

<div class="flex justify-between items-center mb-6">
  <h1 class="text-2xl font-bold text-slate-900"><%= @customer.name || @customer.external_id %></h1>
  <%= render "shared/period_selector", selected: @selected_period %>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
  <div class="stat-card stat-card-green">
    <div class="flex items-center gap-2 mb-1">
      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      <p class="text-sm text-slate-500"><%= t("shared.revenue") %></p>
    </div>
    <p class="text-2xl font-bold text-slate-900"><%= format_cents(@margin.revenue_in_cents) %></p>
  </div>
  <div class="stat-card stat-card-red">
    <div class="flex items-center gap-2 mb-1">
      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
      <p class="text-sm text-slate-500"><%= t("shared.cost") %></p>
    </div>
    <p class="text-2xl font-bold text-slate-900"><%= format_cents(@margin.cost_in_cents) %></p>
  </div>
  <div class="stat-card stat-card-blue">
    <div class="flex items-center gap-2 mb-1">
      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      <p class="text-sm text-slate-500"><%= t("shared.margin") %></p>
    </div>
    <p class="text-2xl font-bold <%= margin_color_class(@margin.margin_in_cents) %>"><%= format_cents(@margin.margin_in_cents) %></p>
  </div>
  <div class="stat-card stat-card-amber">
    <div class="flex items-center gap-2 mb-1">
      <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
      <p class="text-sm text-slate-500"><%= t("shared.margin_percent") %></p>
    </div>
    <p class="text-2xl font-bold <%= margin_color_class(@margin.margin_in_cents) %>"><%= format_bps(@margin.margin_bps) %></p>
  </div>
</div>

<!-- Revenue Breakdown -->
<% if @margin.subscription_revenue_in_cents > 0 || @margin.event_revenue_in_cents > 0 %>
  <div class="card p-6 mb-8">
    <h2 class="text-lg font-semibold text-slate-900 mb-3"><%= t("customers.show.revenue_breakdown") %></h2>
    <div class="flex gap-8 text-sm">
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-blue-500"></div>
        <div>
          <span class="text-slate-500"><%= t("customers.show.invoice_label") %></span>
          <span class="font-medium ml-1"><%= format_cents(@margin.subscription_revenue_in_cents) %></span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
        <div>
          <span class="text-slate-500"><%= t("customers.show.event_based") %></span>
          <span class="font-medium ml-1"><%= format_cents(@margin.event_revenue_in_cents) %></span>
        </div>
      </div>
    </div>
  </div>
<% end %>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
  <!-- Revenue vs Cost Chart -->
  <div class="card p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4"><%= t("customers.show.revenue_vs_cost") %></h2>
    <% if @revenue_over_time.any? || @cost_over_time.any? %>
      <%= line_chart [
        { name: t("shared.revenue"), data: @revenue_over_time },
        { name: t("shared.cost"), data: @cost_over_time }
      ], prefix: "$" %>
    <% else %>
      <div class="empty-state"><p><%= t("shared.no_data") %></p></div>
    <% end %>
  </div>

  <!-- Vendor Cost Breakdown -->
  <div class="card p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4"><%= t("customers.show.cost_by_vendor") %></h2>
    <% if @vendor_costs.any? %>
      <%= pie_chart @vendor_costs.transform_values { |v| v / 100.0 }, prefix: "$" %>
    <% else %>
      <div class="empty-state">
        <svg class="w-10 h-10 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg>
        <p><%= t("customers.show.no_cost_data") %></p>
      </div>
    <% end %>
  </div>
</div>

<!-- Margin by Event Type -->
<div class="card p-6" data-controller="clickable-chart" data-clickable-chart-urls-value="<%= @event_type_urls.to_json %>">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-lg font-semibold text-slate-900"><%= t("customers.show.margin_by_event_type") %></h2>
    <%= link_to t("customers.show.view_all"), events_path(customer_id: [@customer.id], ref: "customer"), class: "text-sm link" %>
  </div>
  <% if @event_type_margins.any? %>
    <%= bar_chart @event_type_margins, suffix: "%" %>
  <% else %>
    <div class="empty-state">
      <svg class="w-10 h-10 mx-auto mb-2 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      <p><%= t("customers.show.no_events") %></p>
    </div>
  <% end %>
</div>
