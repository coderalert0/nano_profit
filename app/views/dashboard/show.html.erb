<div data-controller="dashboard" data-dashboard-organization-id-value="<%= @organization.id %>">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-900"><%= t("dashboard.show.title") %></h1>
    <%= render "shared/period_selector", selected: @selected_period %>
  </div>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <p class="text-sm text-gray-500"><%= t("dashboard.show.total_revenue") %></p>
      <p class="text-2xl font-bold text-gray-900" id="total-revenue"><%= format_cents(@margin.revenue_in_cents) %></p>
      <% if @margin.subscription_revenue_in_cents > 0 %>
        <p class="text-xs text-gray-400 mt-1"><%= t("dashboard.show.subscription_label", subscription: format_cents(@margin.subscription_revenue_in_cents), event: format_cents(@margin.event_revenue_in_cents)) %></p>
      <% end %>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <p class="text-sm text-gray-500"><%= t("dashboard.show.total_cost") %></p>
      <p class="text-2xl font-bold text-gray-900" id="total-cost"><%= format_cents(@margin.cost_in_cents) %></p>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <p class="text-sm text-gray-500"><%= t("shared.margin") %></p>
      <p class="text-2xl font-bold <%= margin_color_class(@margin.margin_in_cents) %>" id="total-margin"><%= format_cents(@margin.margin_in_cents) %></p>
    </div>
    <div class="bg-white rounded-lg shadow p-6">
      <p class="text-sm text-gray-500"><%= t("shared.margin_percent") %></p>
      <p class="text-2xl font-bold <%= margin_color_class(@margin.margin_in_cents) %>" id="margin-pct"><%= format_bps(@margin.margin_bps) %></p>
    </div>
  </div>

  <!-- Revenue vs Cost Chart -->
  <div class="bg-white rounded-lg shadow p-6 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4"><%= t("dashboard.show.revenue_vs_cost_over_time") %></h2>
    <%= line_chart [
      { name: t("shared.revenue"), data: @revenue_over_time },
      { name: t("shared.cost"), data: @cost_over_time }
    ], prefix: "$", library: { scales: { y: { beginAtZero: true } } } %>
  </div>

  <!-- Vendor Cost Breakdown -->
  <% if @vendor_costs.any? %>
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="text-lg font-semibold text-gray-900 mb-4"><%= t("dashboard.show.cost_by_vendor") %></h2>
      <%= pie_chart @vendor_costs.transform_values { |v| v / 100.0 }, prefix: "$" %>
    </div>
  <% end %>

  <!-- Live Event Feed -->
  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-gray-900"><%= t("dashboard.show.recent_events") %></h2>
      <% if @unacknowledged_alerts_count > 0 %>
        <%= link_to alerts_path, class: "text-sm text-red-600 font-medium" do %>
          <%= t("dashboard.show.unacknowledged_alerts", count: @unacknowledged_alerts_count) %>
        <% end %>
      <% end %>
    </div>

    <div id="event-feed">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b text-left text-gray-500">
            <th class="py-2 pr-4"><%= t("shared.time") %></th>
            <th class="py-2 pr-4"><%= t("shared.customer") %></th>
            <th class="py-2 pr-4"><%= t("shared.event_type") %></th>
            <th class="py-2 pr-4 text-right"><%= t("shared.revenue") %></th>
            <th class="py-2 pr-4 text-right"><%= t("shared.cost") %></th>
            <th class="py-2 text-right"><%= t("shared.margin") %></th>
          </tr>
        </thead>
        <tbody id="events-table-body">
          <% @recent_events.each do |event| %>
            <%= render partial: "dashboard/event_row", locals: { event: event } %>
          <% end %>
          <% if @recent_events.empty? %>
            <tr id="no-events-row">
              <td colspan="6" class="py-8 text-center text-gray-400"><%= t("dashboard.show.no_events") %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
